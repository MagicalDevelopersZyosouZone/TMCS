<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <title></title>
        <meta name="viewport" content="width=device-width,initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no,target-densitydpi=device-dpi" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="browsermode" content="application" />
        <meta name="full-screen" content="true" />
        <script src="lib/jQuery/jquery.min.js"></script>
        <script src="../TMCS.js"></script>
        <script src="lib/HTMLTemplate/HTMLTemplate.js"></script>
        <script src="lib/HTMLTemplate/ObserveList.js"></script>
        <script src="lib/pidCrypt/pidcrypt_c.js"></script>
        <script src="lib/pidCrypt/pidcrypt_util_c.js"></script>
        <script src="lib/pidCrypt/sha512_c.js"></script>
        <script src="lib/jsencrypt/jsencrypt.min.js"></script>
        <link rel="stylesheet" type="text/css" href="style.css"/>
        <style>

        </style>
        <!--<link rel="stylesheet" type="text/css" href="themes/dark.css"/>-->
    </head>
    <body oncontextmenu="return false;">
        <div id="login">
            <div id="login-title" onselectstart="return false">Login</div>
            <div id="login-input">
                <input type="text" id="uid" placeholder="Username" />
                <input type="password" id="pwd" placeholder="Password" />
                <div id="buttons">
                    <a id="buttonLogin" class="button">Sign in</a>
                    <a id="buttonRegister" class="button">Sign up</a>
                </div>
            </div>
            <p id="error-output">Unknown error.</p>
            <!--<i id="buttonLogin" class="icon" onselectstart="return false">arrow_forward</i>-->
        </div>
        <div id="register">
            
        </div>
        <div id="main" style="display: none;">
            <div id="side" onselectstart="return false;">
                <div>
                    <div class="item">
                        <i id="buttonMenu" class="icon" onclick="$('#side').removeClass('slideIn');$('#side').addClass('slideOut');">menu</i>
                    </div>
                    <div id="myself" class="item">
                        <img id="face" src="http://img.sardinefish.com/NDc2NTU2"/>
                        <div id="info">
                            <div id="name">My Name</div>
                            <div id="uid">my_uid</div>
                            <div id="status" class="online"></div>
                        </div>
                    </div>
                    <div id="contact"></div>
                    <div id="contacts">
                        <template id="contactTemplate">
                            <div class="item contact" onclick="contactClick('{uid}')">
                                <img class="face" src="{avatar}"/>
                                <div class="info">
                                    <div class="name">{name}</div>
                                    <div class= "status {status}"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            <div id="center">
                <div id="top" onselectstart="return false;">
                    <i id="buttonMenu" class="icon" onclick="$('#side').removeClass('slideOut');$('#side').addClass('slideIn');">menu</i>
                    <div id="title">Title</div>
                </div>
                <div id="chat">
                    <div class="msgOpp">
                        <img class="face" src="img/User_50.min.png"/>
                        <div class="msgBox">
                            <div class="arrow"></div>
                            <div class="msg">Hello!</div>
                        </div>
                    </div>
                    <div class="msgOpp">
                        <img class="face" src="img/User_50.min.png"/>
                        <div class="msgBox">
                            <div class="arrow"></div>
                            <div class="msg">
                                Hey!
                                <br>
                                You!
                            </div>
                        </div>
                        
                    </div>
                    <div class="msgSelf">
                        <div class="msgBox">
                            <div class="arrow"></div>
                            <div class="msg">I see...</div>
                        </div>
                        <img class="face" src="img/User_50.min.png"/>
                    </div>
                </div>
                <div id="footer">
                    <div id="inputArea">
                        <div id="input" contenteditable="true">Input</div>
                        <i id="buttonEmoji" class="icon" onselectstart="return false">insert_emoticon</i>
                        <i id="buttonSend" class=icon onselectstart="return false">send</i>
                    </div>
                </div>
            </div>
        </div>
        <script>

            try
            {
                HTMLTemplate.Init();
                var tmcsClient = new TMCS("localhost:5732", false);
                var contactsList = new ObserveList();
                $("#buttonMenu").click(function (e)
                {

                });
                $("#buttonLogin").click(function (e)
                {
                    tmcsClient = new TMCS("localhost:5732", false);
                    $("#login #error-output").text("");
                    var uid = $("#uid").val();
                    var pwd = $("#pwd").val();
                    tmcsClient.login(uid, pwd, function (result)
                    {
                        if (result.code == 0)
                        {
                            $("#main").css("display", "block");
                            $("#login").animate({ opacity: 0 }, 500, function ()
                            {
                                $("#login").css("display", "none");
                            });
                            initUser();
                        }
                        else
                        {
                            $("#login #error-output").text(result.data);
                        }
                    });
                    return;
                    login(uid, pwd, function (succeed, msg)
                    {
                        if (!succeed)
                        {
                            alert(msg);
                            return;
                        }
                        
                    });
                });
                function contactClick(uid)
                {
                    initChat(uid);
                }
                function initChat(uid)
                {
                    chatting = contacts[uid];
                    $("#top #title").text(uid);

                }
                var contacts = [];
                var chatting = null;
                function initUser()
                {
                    tmcsClient.user.getProfile(function (result)
                    {
                        if (result.code == 0)
                        {

                        }
                    });
                    return;
                    getContacts(function (list)
                    {
                        tmcsClient.getContacts(function (result)
                        {
                            if (result.code == 0) {
                                var container = $("#contactTemplate").get(0);
                                contactsList = new ObserveList();
                                for (var i = 0; i < result.data.length; i++) {
                                    var data = result.data[i];
                                    var contact = {
                                        name: data.uid,
                                        avatar: data.profile.avatar,
                                        uid: data.uid,
                                        status: data.profile.status.toLowerCase()
                                    };
                                    if (data.profile.nickName != "")
                                        contact.name = data.profile.nickName;
                                    if (data.note != "")
                                        contact.name = data.note;
                                    contactsList.add(contact);
                                }
                                container.dataSource = contactsList;

                            }

                        });
                        var container = $("#contactTemplate").get(0);
                        container.dataSource = list;
                        //container.html("");
                        //alert(list);
                        contacts = list;
                        for (var i = 0; i < list.length; i++)
                        {
                            contacts.msg = [];
                            contacts[contacts[i].uid] = contacts[i];
                        }
                        //$(".contact").click(contactClick);
                    });
                    startRecv(function (msg)
                    {
                        contacts[msg.sender].msg.add(msg);
                    });
                }
            }
            catch (ex)
            {
                alert("global:" + ex.message);
            }
        </script>
    </body>
</html>